<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Easy Aurora Forecast v. t1.10.7</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b132b">
<link rel="apple-touch-icon
" href="icon.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { font-family: system-ui, sans-serif; background:#0b132b; color:#eaeaea; padding:20px; margin:0; }
.container { max-width:600px; margin: 0 auto; }
.header-area { display: flex; flex-direction: column; margin-bottom: 10px; }
.produce-by { font-size: 0.7rem; color: #8b949e; margin-top: -5px; margin-bottom: 10px; align-self: flex-end; }
.version { font-size: 0.4em; vertical-align: middle; color: #5bc0be; margin-left: 8px; font-weight: normal; }
.title-row { display: flex; justify-content: space-between; align-items: baseline; width: 100%; }
.beta-suffix { font-size: 0.6em; color: #8b949e; font-weight: normal; margin-left: 5px; text-transform: lowercase; }
h1 { margin: 0; font-size: 1.5rem; }
.card { background:#1c2541; padding:20px; border-radius:12px; margin-bottom:20px; position: relative; border: 1px solid #30363d; }
.label-main { font-size: 1.1rem; font-weight: bold; color: #5bc0be; margin-bottom: 0px; }
.label-sub-current { font-size: 0.8rem; color: #8b949e; margin-bottom: 10px; }
.value { font-size:1.6em; margin-top:4px; min-height: 1.2em; }
.sub-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #30363d; position: relative; }
.hidden {
    display: none !important;
}

.badge {
    display: inline-block;
    padding: 10px 24px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 1.2rem;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    margin-top: 5px;
    position: relative;
    /* --- è¿½åŠ ãƒ»ä¿®æ­£ --- */
    border: none;       /* ãƒœã‚¿ãƒ³ã®æ ç·šã‚’æ¶ˆã™ */
    cursor: pointer;    /* ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸæ™‚ã«æŒ‡ãƒãƒ¼ã‚¯ã«ã™ã‚‹ */
    color: white;       /* æ–‡å­—è‰²ã‚’ç™½ã«å›ºå®š */
    transition: transform 0.1s, filter 0.2s; /* æŠ¼ã—å¿ƒåœ°ã®ãŸã‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
}

/* è¿½åŠ ï¼šãƒã‚¦ã‚¹ã‚’ç½®ã„ãŸæ™‚ã«å°‘ã—æ˜ã‚‹ã/
.badge:hover {
    filter: brightness(1.2); /* æ˜ã‚‹ã•ã‚’20%ã‚¢ãƒƒãƒ— */
    /* transform: translateY(-2px); 2pxã ã‘ä¸Šã«æµ®ã‹ã™(ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆä¸­) */
}

/* ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.badge:active {
    transform: scale(0.95); /* å°‘ã—å‡¹ã‚€æ¼”å‡º */
    filter: brightness(0.9); /* å°‘ã—æš—ãã™ã‚‹æ¼”å‡º */
}

.badge-large { font-size: 1.5rem; }
.low { background:#475569; } .mid { background:#ca8a04; } .high { background:#dc2626; }
.cloud-icon { font-size: 0.8em; margin-left: 8px; vertical-align: middle; }
input, button { margin-top:6px; padding:6px 12px; border-radius: 4px; border: none; font-weight: bold; }

/* 1. é€šå¸¸ã®ãƒœã‚¿ãƒ³ (GPSãƒœã‚¿ãƒ³ãªã©) */
button { 
    cursor: pointer; 
    background: #3a506b; 
    color: white; 
    transition: 0.2s; 
    font-size: 0.9rem; 
}
/* 2. ãƒãƒƒã‚¸å‹ãƒœã‚¿ãƒ³ (Overall Probability, Aurora Oval) */
/* 1. é€šå¸¸ãƒœã‚¿ãƒ³ã¨ãƒãƒƒã‚¸ã®åŸºæœ¬é·ç§»è¨­å®š */
button, .badge {
    transition: 0.2s; /* å¤‰åŒ–ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ */
}

/* 2. ãƒ›ãƒãƒ¼æ™‚ï¼ˆãƒã‚¦ã‚¹ã‚’ç½®ã„ãŸæ™‚ï¼‰ï¼šæ˜ã‚‹ã•ã‚’å¤‰ãˆã‚‹æ¼”å‡ºã«çµ±ä¸€ */
button:hover:not(:disabled),
.badge:hover {
    filter: brightness(1.3) !important; /* å€‹åˆ¥ã®è‰²æŒ‡å®šã«è² ã‘ãªã„ã‚ˆã†å„ªå…ˆåº¦ã‚’ä¸Šã’ã‚‹ */
    cursor: pointer;
}

/* 3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ãŸç¬é–“ï¼‰ï¼šã‚ãšã‹ã«å‡¹ã¾ã›ã‚‹ */
button:active:not(:disabled),
.badge:active {
    transform: scale(0.97); /* æµ®ãä¸ŠãŒã‚‰ã›ãšã€å°‘ã—æ²ˆã‚€ã ã‘ã«ã™ã‚‹ */
    filter: brightness(0.9) !important;
}

/* --- ä»¥ä¸‹ã¯æ—¢å­˜ã®å€‹åˆ¥è¨­å®šã‚’ç¶­æŒ --- */
.badge {
    display: inline-block;
    padding: 10px 24px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 1.2rem;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    margin-top: 5px;
    position: relative;
    border: none;
    color: white;
}

button:disabled { opacity: 0.3; cursor: not-allowed; }
#btn-gps { width: auto; min-width: 220px; padding: 10px 20px; margin-bottom: 15px; }
.search-container { position: relative; display: inline-block; width: 100%; margin-top: 5px; }
#cityInput { width: calc(100% - 100px); box-sizing: border-box; }
.autocomplete-items { position: absolute; border: 1px solid #3a506b; border-bottom: none; border-top: none; z-index: 99; top: 100%; left: 0; right: 100px; background-color: #1c2541; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; }
.autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #30363d; font-size: 0.85rem; }
.autocomplete-item:hover { background-color: #3a506b; color: #5bc0be; }
.refresh-btn { position: absolute; top: 15px; right: 15px; font-size: 0.8em; padding: 4px 8px; }
.sub-refresh-btn { position: absolute; top: 15px; right: 0; font-size: 0.8em; padding: 4px 8px; }
.last-updated { font-size: 0.65rem; color: #8b949e; text-align: right; margin-top: 4px; font-family: monospace; min-height: 1em; }
.error-msg { color: #ff6b6b; font-size: 0.75rem; margin-top: 5px; min-height: 1em; opacity: 0; transition: 0.3s; }
.loading-text { opacity: 0.6; font-size: 1rem; color: #8b949e; font-style: normal; }
.loading-text i { font-style: italic; }
.loading-btn { pointer-events: none; filter: grayscale(0.5); opacity: 0.7; }
#hidden-data { display: none; }
.toggle-btn { width: 100%; margin-bottom: 20px; background: #1c2541; border: 1px solid #3a506b; color: #5bc0be; }
pre { background:#0b132b; padding:12px; border-radius:8px; font-family: monospace; font-size: 0.85em; overflow-x: auto; white-space: pre-wrap; border: 1px solid #3a506b; min-height: 50px; }
#welcome-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 30000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
.welcome-box { background: #5bc0be; color: #0b132b; padding: 25px; border-radius: 15px; text-align: center; font-weight: bold; font-size: 1.1rem; z-index: 30001; }
.arrow-container { display: flex; gap: 15px; margin-bottom: 10px; }
.thin-arrow { font-size: 2.5rem; color: #5bc0be; font-weight: 100; animation: bounceThin 1.2s infinite; }
@keyframes bounceThin { 0%, 100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(-15px); opacity: 1; } }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; justify-content: center; align-items: center; cursor: pointer; }

.modal-content { background: #1c2541;
	width: 90%; 
	max-width: 450px; 
	padding:25px;
	border-radius: 12px; position:
	relative; border: 1px solid #5bc0be; 
	line-height: 1.6;
	cursor: pointer; /* default ã‹ã‚‰ pointer ã«å¤‰æ›´ */;
	max-height: 90vh; overflow-y: auto; }

.close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #8b949e; }
.score-big { font-size: 2.5rem; text-align: center; color: #fff; margin: 10px 0; font-weight: bold; }
.detail-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; margin-top: 10px; margin-bottom: 15px; }
.detail-table th, .detail-table td { text-align: left; padding: 8px; border-bottom: 1px solid #30363d; }
#map-screen { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; background: #000; }
#map { width: 100%; height: 100%; background: #000; }
#back-btn { position: absolute; top: 90px; left: 10px; z-index: 10000; background: #21262d; border: 1px solid #30363d; color: white; padding: 8px 16px; }
.notification-card { border: 1px dashed #5bc0be !important; margin-top: 10px; }
.btn-test { background: #ca8a04 !important; }
.switch-container { display: flex; align-items: center; justify-content: flex-end; margin-top: 12px; gap: 10px; }
.switch-label { font-size: 0.75rem; color: #8b949e; }
.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a506b; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #5bc0be; }
input:checked + .slider:before { transform: translateX(20px); }

/* è¿½åŠ ï¼šç”»åƒã¨ãƒœã‚¿ãƒ³ã‚’ç¸¦ã«ä¸¦ã¹ã¦ä¸­å¤®ã«æƒãˆã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */
.status-display-area {
    display: flex;
    flex-direction: column;
    align-items: center;  /* æ¨ªæ–¹å‘ã®ä¸­å¤®æƒãˆ */
    justify-content: center;
    gap: 15px;           /* ç”»åƒã¨ãƒœã‚¿ãƒ³ã®é–“ã®éš™é–“ */
    width: 100%;
    margin: 10px 0;
}

</style>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>




</head>
<body onkeydown="closeWelcome()" onclick="closeWelcome(); closeAllLists();">

<div id="welcome-overlay" class="overlay hidden">
    <div class="arrow-container">
        <div class="thin-arrow">â†‘</div><div class="thin-arrow">â†‘</div><div class="thin-arrow">â†‘</div>
    </div>
    <div class="welcome-box">Please enter a location first</div>
</div>

<div id="home-screen" class="container">
    <div class="header-area">
        <div class="title-row">
            <h1>ğŸŒŒ Easy Aurora Forecast<span class="beta-suffix">(beta)</span> <span class="version">v. t1.10.7</span></h1>
        </div>
        <div class="produce-by">Produce by Shin</div>
    </div>


<!-- App Settings (Temporarily Disabled)
    <div class="card notification-card">
        <div class="label-main" style="font-size: 0.9rem;">App Settings</div>
        <button id="btn-notif-test" class="btn-test" onclick="testNotification(); event.stopPropagation();">Send Test Notification</button>
        <div id="notif-status" style="font-size: 0.7rem; color: #8b949e; margin-top: 5px;">Push notifications: Triggered on "Possible" or "High"</div>
    </div>``
-->


    <div class="card" id="card-loc">
        <div class="label-main">Location</div>
        <div id="loc" class="value">Not Set</div>
        <button id="btn-gps" onclick="getLocation(); event.stopPropagation();">Get Current Location via GPS</button><br>
        Search City:
        <div class="search-container">
            <input id="cityInput" placeholder="e.g. Yellowknife, Canada" 
       oninput="handleCityInput(this)" 
       onclick="event.stopPropagation()">
            <button id="btn-search" onclick="searchCity()">Set</button>
            <div id="autocomplete-list" class="autocomplete-items"></div>
        </div>
        <div id="search-error" class="error-msg">City not found. Please check your input.</div>
    </div>

    <div class="card" id="card-main-result">


    <div id="total-label" class="label-main">Overall Probability</div>
    <div id="total-sub-label" class="label-sub-current">Current:</div>

    <div id="possibility-area" style="text-align: center; margin: 15px 0; display: flex; flex-direction: column; align-items: center; gap: 15px;">
    
        <img id="status-icon" 
             src="low.png" 
             alt="Status" 
             onclick="openModal()" 
             style="width: 180px; height: auto; cursor: pointer; -webkit-tap-highlight-color: transparent;">
    
        <div id="result" 
             class="badge badge-large low" 
             onclick="openModal()"
             style="margin: 0 auto;">Low</div>
    </div>

    <div class="last-updated" id="time-update-all">Last Update: --:--:--</div>








    
    <div class="switch-container" style="position: absolute; top: 15px; right: 22px; margin-top: 0; display: flex; flex-direction: column; align-items: flex-end;">
    	<div style="display: flex; align-items: center; gap: 10px;">
        	<span class="switch-label">Notification</span>
        	<label class="switch">
            	<input type="checkbox" id="notif-toggle">
            	<span class="slider"></span>
        	</label>
    	</div>
    	<div id="target-area-display" style="font-size: 0.65rem; color: #5bc0be; margin-top: 5px; text-align: right; line-height: 1.2; display: none;">
        	Target area:<br>
        	<span id="target-area-name" style="color: #eaeaea;"></span>
    	</div>
	</div>

    <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
    	<button id="btn-update-all" 
            	style="width: auto; min-width: 100px; white-space: nowrap; font-size: 0.85em; background: #3a506b; padding: 8px 12px;" 
            	onclick="updateAll(); event.stopPropagation();">
        	Update Data
    	</button>
	</div>
    
    <div id="time-update-all" class="last-updated" style="margin-top: 10px;"></div>
</div>

    <button id="toggle-data-btn" class="toggle-btn" onclick="toggleData(); event.stopPropagation();">Show All Information</button>

    <div id="hidden-data">
        <div class="card" id="card-oval">
            <div class="label-main">Aurora Oval</div>
            <div class="label-sub-current">Current: (Click to View Map)</div>
            <div id="oval" class="badge low" onclick="showMapScreen(); event.stopPropagation();">--</div>
            <div id="oval-prob" style="font-size: 0.9rem; color: #8b949e; margin: 10px 0;"></div>
        </div>

        <div class="card" id="card-kp-group">
            <div class="label-main">Kp Index</div>
            <div class="label-sub-current">Current:</div>
            <div id="kp" class="badge low">--</div>
            <div class="sub-section" id="card-kp3">
                <div style="font-size: 0.8rem; color: #8b949e; margin-bottom: 5px;">Short Forecast:</div>
                <div id="kp-short" class="value" style="font-size: 0.85rem; color: #5bc0be;">Ref 3-day forecast (NOAA)</div>
                <pre id="kpForecast" style="margin-top:10px;">--</pre>
            </div>
        </div>

        <div class="card" id="card-cloud-group">
            <div class="label-main">Cloud Cover</div>
            <div class="label-sub-current">Current:</div>
            <div id="cloud" class="badge low">--</div>
            <div class="sub-section" id="card-short">
                <div style="font-size: 0.8rem; color: #8b949e; margin-bottom: 5px;">Short Forecast:</div>
                <div id="forecast" class="value" style="font-size: 1rem;">--</div>
            </div>
        </div>
    </div>
</div>





<div id="detailModal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content">
        <div class="modal-title">Probability Details</div>
        
        <div style="border: 1px solid #3a506b; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #0b132b;">
            <strong style="color: #5bc0be;">Thresholds:</strong>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.85rem;">
                <li><span style="color: #dc2626;">High</span>: 70% or more</li>
                <li><span style="color: #ca8a04;">Possible</span>: 35% to 69%</li>
                <li><span style="color: #8b949e;">Low</span>: Under 35%</li>
            </ul>
        </div>

        <div id="radar-container" style="
            position: relative; 
            max-width: 500px; 
            height: 300px; /* 360pxã‹ã‚‰ã•ã‚‰ã«ç¸®å° */
            margin: 0 auto -40px; /* ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚¸ãƒ³ã‚’ã•ã‚‰ã«å¼·ãè¨­å®š */
            overflow: hidden; /* ã¯ã¿å‡ºã—ã‚’ã‚«ãƒƒãƒˆã—ã¦å¯†ç€ã•ã›ã‚‹ */
        ">
            <canvas id="radarChart"></canvas>
            <div id="chart-center-pct" style="
                position: absolute; 
                top: 50%; 
                left: 50%; 
                transform: translate(-50%, -50%); 
                font-size: 2.2rem; 
                font-weight: bold; 
                color: #fff;
                text-shadow: 0 0 10px rgba(0,255,150,0.8);
                pointer-events: none;
                line-height: 1; /* è¡Œé–“ã®ä½™ç™½ã‚’è©°ã‚ã¦å‚ç›´ä¸­å¤®ã‚’æ­£ç¢ºã« */
            ">--%</div>
        </div>

        <div style="font-size: 0.85rem;">
            <strong>Optimized Logic (v t1.0.13+):</strong>
            <table class="detail-table">
                <tr><th>Item</th><th>Max</th><th>Details</th></tr>
                <tr><td>Oval/Horizon</td><td>45</td><td>Base prob + Viewline bonus</td></tr>
                <tr><td>Magnetic</td><td>40</td><td>Kp Index sensitivity adjusted</td></tr>
                <tr><td>Sky</td><td>15</td><td>Clear sky impact</td></tr>
            </table>
            <p style="margin-top:10px; color: #ffab70; font-size: 0.8rem;">
                * <strong>Cloud Impact:</strong> If cloud cover exceeds 70%, the score is significantly reduced. If it exceeds 85%, the result is forced to "Low".<br><br>
                * <strong>Cloud overlay:</strong> <strong>Clounds</strong> will be added to the image when other conditions are favorable but thick cloud cover reduces aurora visability.
            </p>
        </div>
    </div>
</div>




<div id="map-screen">
    <button class="btn" id="back-btn" onclick="hideMapScreen();">â† Back</button>
    <div id="map"></div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- 1. å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
const PUBLIC_KEY = 'BAp0wnGuvaoZk_Q7Bn4H4DWAR2Zdi9juZECl10m290Ff9sAJqiaXepWYvGgbI7WOb9K3O0MOTG8TVi_hg_ovfEg';

const GAS_URL = "https://script.google.com/macros/s/AKfycbx0pgTPAViJbZXOFzdHbAAfll7UJkvxyyiWIEbADoqNsdHzwJUacvgVvz5VPJowR2hicg/exec";
const CORS = GAS_URL + "?url="; // GASãƒ—ãƒ­ã‚­ã‚·ã¯ã‚„ã‚ã¦ã€å®‰å®šã—ãŸAllOriginsã«æˆ»ã—ã¾ã™

// å€™è£œB (äºˆå‚™):
// const CORS = "https://thingproxy.freeboard.io/fetch/";
// const CORS = "https://cors-proxy.org/?url=";

const KP_URL = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json";
const OVAL_URL = "https://services.swpc.noaa.gov/json/ovation_aurora_latest.json";
const FORECAST_URL = "https://services.swpc.noaa.gov/text/3-day-forecast.txt";

let myLat = null, myLon = null, currentTotalScore = 0, lastAuroraProb = 0;
let notifLat = null, notifLon = null, notifName = ""; // é€šçŸ¥ç”¨ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
let cachedAuroraData = null, map = null, auroraLayer = null, userMarker = null, cloudDataHourly = null;
let searchTimer = null, lastScrollPos = 0;

// --- 2. åˆæœŸåŒ–å‡¦ç† (DOMContentLoaded) ---
document.addEventListener('DOMContentLoaded', async () => {
    // Service Worker ç™»éŒ²
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // --- A. ã€Œæœ€å¾Œã«è¡¨ç¤ºã—ã¦ã„ãŸå ´æ‰€ã€ã®å¾©å…ƒ ---
    const savedLat = localStorage.getItem('aurora_myLat');
    const savedLon = localStorage.getItem('aurora_myLon');
    const savedName = localStorage.getItem('aurora_myName');
    
    // --- B. ã€Œé€šçŸ¥ç”¨ã«å›ºå®šã—ãŸå ´æ‰€ã€ã®å¾©å…ƒ ---
    notifLat = localStorage.getItem('aurora_notifLat') ? parseFloat(localStorage.getItem('aurora_notifLat')) : null;
    notifLon = localStorage.getItem('aurora_notifLon') ? parseFloat(localStorage.getItem('aurora_notifLon')) : null;
    notifName = localStorage.getItem('aurora_notifName') || "";

    // --- C. é€šçŸ¥ã‚¹ã‚¤ãƒƒãƒã®çŠ¶æ…‹ã¨è¡¨ç¤ºã®å¾©å…ƒ ---
    const savedEnabled = localStorage.getItem('aurora_enabled') === 'true';
    const pushSwitch = document.getElementById("notif-toggle");
    
    if (pushSwitch) {
        pushSwitch.checked = savedEnabled;
        pushSwitch.addEventListener('change', handleNotifToggleEvent);
    }

    if (savedEnabled && notifName) {
        const targetDisplay = document.getElementById("target-area-display");
        const targetNameLabel = document.getElementById("target-area-name");
        if (targetDisplay) targetDisplay.style.display = "block";
        if (targetNameLabel) targetNameLabel.textContent = notifName;
    }

// --- D. ãƒ¡ã‚¤ãƒ³ç”»é¢ã®èª­ã¿è¾¼ã¿ã¨çŸ›ç›¾ã®è§£æ¶ˆ ---
    if (savedLat && savedLon) {
        myLat = parseFloat(savedLat);
        myLon = parseFloat(savedLon);
        
        // 1. ã¾ãšä½æ‰€ã‚’è¡¨ç¤ºï¼ˆä¿å­˜åãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°é€†å¼•ãï¼‰
        if (savedName) {
            document.getElementById("loc").textContent = savedName;
        } else {
            await reverseGeocode(myLat, myLon);
        }

        // âŒ å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼šèµ·å‹•ã®ãŸã³ã«GASã¸é€ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
        // await subscribeUser(); 

        // âœ… ä»£ã‚ã‚Šã«ï¼šé€šçŸ¥ãŒæœ‰åŠ¹ãªè¨­å®šãªã®ã«ãƒ–ãƒ©ã‚¦ã‚¶å´ã§è¨±å¯ãŒæ¶ˆãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if (savedEnabled && Notification.permission !== "granted") {
            console.warn("Notification permission lost on this device.");
            // å¿…è¦ãªã‚‰ã“ã“ã§ã‚¹ã‚¤ãƒƒãƒã‚’OFFã«æˆ»ã™ãªã©ã®å‡¦ç†
        }

        // 4. ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        updateAll();

    } else {
        // æœ¬å½“ã«ä½•ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ã¿ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¦å…¥åŠ›ã‚’ä¿ƒã™
        document.getElementById('welcome-overlay').classList.remove('hidden');
        document.getElementById("loc").textContent = "Please set location";
    }
});

// --- 3. æ¤œç´¢ãƒ»å…¥åŠ›é–¢é€£ (searchCity, handleCityInput, closeAllLists) ---
async function searchCity() {
    const cityInput = document.getElementById("cityInput");
    if (!cityInput) return;
    const city = cityInput.value.trim();
    if (!city) return;

    if (typeof searchTimer !== 'undefined') clearTimeout(searchTimer);

    try {
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.results?.length > 0) {
            const r = data.results[0];

            // --- ã‚ºãƒ¼ãƒ è§£é™¤ã‚»ãƒƒãƒˆ ---
            cityInput.blur(); 
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                const original = viewport.content;
                viewport.content = 'width=device-width, initial-scale=1, maximum-scale=1';
                setTimeout(() => { viewport.content = original; }, 300);
            }
            // ----------------------

            if (typeof setLocation === "function") {
                await setLocation(r.latitude, r.longitude, `${r.name}, ${r.country}`);
            }
            cityInput.value = "";
            if (typeof closeAllLists === "function") closeAllLists();
        }
    } catch (e) { console.error("Search Error:", e); }
}


function handleCityInput(el) {
    const val = el.value.trim();
    document.getElementById("btn-search").disabled = val.length === 0;

    clearTimeout(searchTimer);
    if (val.length < 2) {
        closeAllLists();
        return;
    }

    searchTimer = setTimeout(async () => {
        try {
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=5&language=en`);
            const data = await res.json();
            if (!data) return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°å‡¦ç†ã‚’ä¸­æ–­
            showAutocomplete(data.results);
        } catch(e){ console.error(e); }
    }, 300);
}

function showAutocomplete(results) {
    const list = document.getElementById("autocomplete-list");
    list.innerHTML = "";
    if (!results) return;

    results.forEach(res => {
        const item = document.createElement("div");
        item.className = "autocomplete-item";
        item.innerHTML = `<strong>${res.name}</strong>, ${res.country}`;
        
        item.onmousedown = async (e) => {
            e.preventDefault();

            // --- 1. ã‚¹ãƒãƒ›ç”¨ï¼šã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã€ã‚ºãƒ¼ãƒ ã‚’è§£é™¤ã™ã‚‹ ---
            const cityInput = document.getElementById("cityInput");
            if (cityInput) {
                cityInput.blur(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’å¼•ã£è¾¼ã‚ã‚‹
                cityInput.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            }

            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                const originalContent = viewport.content;
                // ä¸€ç¬ã ã‘æœ€å¤§ã‚ºãƒ¼ãƒ ã‚’1å€ã«å›ºå®šã—ã¦ãƒªã‚»ãƒƒãƒˆ
                viewport.content = 'width=device-width, initial-scale=1, maximum-scale=1';
                setTimeout(() => {
                    viewport.content = originalContent; // å…ƒã®è¨­å®šã«æˆ»ã™
                }, 300);
            }

            // --- 2. é€šå¸¸ã®ä½ç½®ã‚»ãƒƒãƒˆå‡¦ç† ---
            await setLocation(res.latitude, res.longitude, `${res.name}, ${res.country}`);
            closeAllLists();
        };
        list.appendChild(item);
    });
}

function closeAllLists() {
    const list = document.getElementById("autocomplete-list");
    if (list) list.innerHTML = "";
}

// --- 4. ä½ç½®è¨­å®šãƒ»GASåŒæœŸ ---
async function setLocation(lat, lon, name) {
    // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æœ€æ–°ã«æ›´æ–°
    // æ•°å€¤ã¨ã—ã¦ç¢ºå®Ÿã«æ‰±ã†ãŸã‚ã« parseFloat ã‚’é€šã™
    const newLat = parseFloat(lat);
    const newLon = parseFloat(lon);
    
    myLat = newLat; 
    myLon = newLon;
    
    // 2. UIè¡¨ç¤ºã‚’æ›´æ–°
    document.getElementById("loc").textContent = name;
    
    // 3. ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼ˆæ¬¡å›èµ·å‹•ç”¨ï¼‰
    localStorage.setItem('aurora_myLat', lat);
    localStorage.setItem('aurora_myLon', lon);
    localStorage.setItem('aurora_myName', name);
    
    // 4. åœ°å›³ã®ãƒ”ãƒ³ã‚’æ–°ã—ã„å ´æ‰€ã«ç§»å‹•
    if (map) {
        // â˜…ä¿®æ­£ï¼šå¼•æ•°ã¨ã—ã¦æ–°ã—ã„åº§æ¨™ã‚’ç›´æ¥æ¸¡ã™
        updateMapMarker(newLat, newLon);
        map.setView([lat, lon], map.getZoom()); // æ¤œç´¢ã—ãŸå ´æ‰€ã«åœ°å›³ã‚’é£›ã°ã™
    }
    
    // 5. æœ€æ–°ã®åº§æ¨™ã«åŸºã¥ã„ã¦è¨ˆç®—ï¼ˆOverall Possibilityãªã©ï¼‰
    // ä¿®æ­£ã€‘await ã‚’å¤–ã—ã€ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚æ¬¡ã«é€²ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹
    // ã“ã‚Œã«ã‚ˆã‚Šã€updateAll ãŒé‡ãã¦ã‚‚é€”ä¸­ã§æ­¢ã¾ã£ã¦ã‚‚ã€é–¢æ•°è‡ªä½“ã¯å®Œäº†ã—ã€UIã®ãƒ•ãƒªãƒ¼ã‚ºã‚’é˜²ã’ã¾ã™ã€‚
    updateAll().catch(err => console.error("UpdateAll failed in background:", err));
}


//GPSã§ä½ç½®æƒ…å ±å–å¾—
async function getLocation() {
    setItemLoading('loc', true);
    
    navigator.geolocation.getCurrentPosition(async p => {
        // 1. åº§æ¨™ã‚’æ•°å€¤ã¨ã—ã¦å–å¾—
        const lat = p.coords.latitude;
        const lon = p.coords.longitude;

        // 2. ã€Œçˆ†é€Ÿç‰ˆ setLocationã€ã‚’å³åº§ã«å®Ÿè¡Œï¼
        // ã“ã‚Œã«ã‚ˆã‚Šã€ä½æ‰€æ¤œç´¢ã‚’å¾…ãŸãšã«åœ°å›³ã¨ãƒ”ãƒ³ãŒæ–°ã—ã„å ´æ‰€ã«é£›ã³ã¾ã™ã€‚
        // ã¨ã‚Šã‚ãˆãšåœ°åã¯ "Loading address..." ãªã©ã«ã—ã¦ãŠãã¾ã™ã€‚
        await setLocation(lat, lon, "Locating...");

        // 3. ãã®å¾Œã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä½æ‰€ã‚’èª¿ã¹ã¦è¡¨ç¤ºã‚’ä¸Šæ›¸ã
        try {
            await reverseGeocode(lat, lon); 
            // å–å¾—ã—ãŸä½æ‰€ã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            const finalName = document.getElementById("loc").textContent;
            localStorage.setItem('aurora_myName', finalName);
        } catch (e) {
            console.error("Address lookup failed:", e);
        }

        // â€» updateAll ã¯ setLocation ã®ä¸­ã§ï¼ˆéåŒæœŸã§ï¼‰å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€
        // ã“ã“ã§æ”¹ã‚ã¦å‘¼ã¶å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆäºŒé‡å®Ÿè¡Œã‚’é˜²ã’ã¾ã™ï¼‰ã€‚
        
    }, err => {
        console.error(err);
        document.getElementById('loc').textContent = "Location Error";
        setItemLoading('loc', false);
    });
}

// é€šçŸ¥ã®è³¼èª­ï¼ˆsubscribe)
async function subscribeUser() {
    // 1. ã¾ãšç¾åœ¨ã®æ¨©é™ã‚’ã€Œç¢ºèªã€ã™ã‚‹ (ã“ã‚Œãªã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯å‡ºãªã„)
    let permission = Notification.permission;

    // 2. ã¾ã ä¸€åº¦ã‚‚è¨±å¯/æ‹’å¦ã—ã¦ã„ãªã„(default)å ´åˆã ã‘ã€è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
    if (permission === "default") {
        permission = await Notification.requestPermission();
    }

    // 3. æœ€çµ‚çš„ãªåˆ¤å®š
    if (permission !== "granted") {
        // ã“ã“ã§ã‚¢ãƒ©ãƒ¼ãƒˆãŒå‡ºã‚‹ã®ã¯ã€Œæœ¬å½“ã«æ‹’å¦ã•ã‚Œã¦ã„ã‚‹æ™‚ã€ã ã‘ã«ãªã‚Šã¾ã™
        alert("To enable notifications, please allow notificatoins in your browser settings.");
        const toggle = document.getElementById("notif-toggle");
        if (toggle) toggle.checked = false; 
        return false;
    }
    
    // --- ä»¥ä¸‹ã€æ—¢å­˜ã® try { ... } ãªã©ã®å‡¦ç†ã¸ç¶šã ---
    
    try {
        // ã‚¹ã‚¤ãƒƒãƒãŒONãªã‚‰ã€å¿…ãšã€Œå›ºå®šã•ã‚ŒãŸå ´æ‰€ã€ã‚’å„ªå…ˆã—ã¦é€ã‚‹
        const isEnabled = document.getElementById("notif-toggle").checked;
        const targetLat = (isEnabled && notifLat !== null) ? notifLat : myLat;
        const targetLon = (isEnabled && notifLon !== null) ? notifLon : myLon;
        
        if (targetLat === null) return false;

        const registration = await navigator.serviceWorker.ready;
        let sub = await registration.pushManager.getSubscription();
        if (!sub) {
            sub = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(PUBLIC_KEY)
            });
        }
        const payload = {
            endpoint: sub.endpoint,
            keys: {
        // å…ˆé ­ã« "'" ã‚’ä»˜ã‘ã¦æ•°å¼èª¤èªã‚’é˜²æ­¢
            p256dh: "'" + btoa(String.fromCharCode.apply(null, new Uint8Array(sub.getKey('p256dh')))),
            auth: "'" + btoa(String.fromCharCode.apply(null, new Uint8Array(sub.getKey('auth'))))
            },
            lat: targetLat, // å›ºå®šã•ã‚ŒãŸç·¯åº¦ã‚’é€ã‚‹
            lon: targetLon, // å›ºå®šã•ã‚ŒãŸçµŒåº¦ã‚’é€ã‚‹
            enabled: isEnabled, // ã“ã‚Œã‚‚å¿…è¦ï¼ (ä»Šã®é€šçŸ¥çŠ¶æ…‹)
            reset: !isEnabled   // ã“ã‚Œã‚’è¿½åŠ ï¼ (OFFã®æ™‚ã«trueã«ãªã‚‹)
        };
            
        await fetch(GAS_URL, { 
            method: 'POST', 
            // mode: 'no-cors' ã‚’å‰Šé™¤ï¼ˆã¾ãŸã¯ 'cors' ã«å¤‰æ›´ï¼‰
            body: JSON.stringify(payload),
            headers: {
                'Content-Type': 'text/plain;charset=utf-8' 
            }
        });
        return true;
    } catch (e) { return false; }
}

async function handleNotifToggleEvent() {
    const isEnabled = this.checked;
    localStorage.setItem('aurora_enabled', isEnabled);

    if (isEnabled) {
        if (myLat === null) {
            alert("Please set a location first.");
            this.checked = false;
            return;
        }

        // â˜…ã‚¹ã‚¤ãƒƒãƒã‚’å…¥ã‚ŒãŸã€Œä»Šã®å ´æ‰€ã€ã‚’é€šçŸ¥ç”¨ã¨ã—ã¦å›ºå®šãƒ»ä¿å­˜
        notifLat = myLat;
        notifLon = myLon;
        notifName = document.getElementById("loc").textContent;

        localStorage.setItem('aurora_notifLat', notifLat);
        localStorage.setItem('aurora_notifLon', notifLon);
        localStorage.setItem('aurora_notifName', notifName);

        const success = await subscribeUser(); // ã“ã®ä¸­ã§é€šçŸ¥ç”¨å¤‰æ•°ã‚’é€ã‚‹ã‚ˆã†ä¿®æ­£
        
        if (success) {
            document.getElementById("target-area-display").style.display = "block";
            document.getElementById("target-area-name").textContent = notifName;
            alert(`Notifications have been set.\nYou'll receive notifications when aurora visibility is possible.\n\nTarget area: ${notifName}`);
        } else {
            this.checked = false;
        }
    } else {
        document.getElementById("target-area-display").style.display = "none";
    }
}

// --- 5. ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»äºˆå ± ---
async function updateAll() {
    if (myLat === null || myLon === null) return;

    const btn = document.getElementById('btn-update-all');
    if(btn) btn.classList.add('loading-btn');
    ['kp','oval','cloud','result'].forEach(id => setItemLoading(id, true));

    try {
        // 1. æ™‚åˆ»åˆ¤å®š
        const now = new Date();
        const hour = now.getHours();
        
        // 3:00 ã€œ 21:00 ã¯æ˜¼é–“ã¨åˆ¤å®š
        const isDaytime = (hour >= 3 && hour < 21);
        const subLabelEl = document.getElementById("total-sub-label");
        
        if (subLabelEl) {
            subLabelEl.textContent = isDaytime ? "Tonight (21:00): " : "Current: ";
        }

        // 2. ãƒ‡ãƒ¼ã‚¿å–å¾— (getCloud ã« isDaytime ã‚’æ¸¡ã™)
        // 429ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã€ã“ã“ã‚’ Promise.all ã§ã¯ãªãä¸€ã¤ãšã¤ await ã™ã‚‹ã®ã‚‚æ‰‹ã§ã™
        await Promise.all([
            getKp(), 
            fetchKp3DayForecast(), 
            checkOval(), 
            getCloud(isDaytime) // â˜… å¼•æ•°ã‚’è¿½åŠ 
        ]);
        
        await shortForecast();

        // 3. ç¢ºç‡è¨ˆç®—
        // ã“ã“ã§ calculateTotal ã«ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã—ã€è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ˜¼å¤œã§åˆ‡ã‚Šæ›¿ãˆã•ã›ã¾ã™
        calculateTotal(isDaytime); 

        updateTimestamp('time-update-all');
    } catch (e) {
        console.error("Update All Error:", e);
    } finally {
        if(btn) btn.classList.remove('loading-btn');
    }
}

async function getKp() {
    try {
        const targetUrl = KP_URL + "?t=" + Date.now();
        const res = await fetch(CORS + encodeURIComponent(targetUrl));
        
        // GASãƒ—ãƒ­ã‚­ã‚·ã®å ´åˆã€ã“ã“ã§ã™ã§ã«NOAAã®ç´”ç²‹ãªãƒ‡ãƒ¼ã‚¿ï¼ˆé…åˆ—ï¼‰ãŒè¿”ã£ã¦ãã¾ã™
        const data = await res.json(); 
        
        // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆGASãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸå ´åˆãªã©ã®å¯¾ç­–ï¼‰
        if (!data || !Array.isArray(data)) {
            console.error("Invalid Kp data received from Proxy");
            return 0;
        }

        // æœ€æ–°ã®Kpå€¤ã‚’å–ã‚Šå‡ºã™ (é…åˆ—ã®æœ€å¾Œ)
        const val = parseFloat(data[data.length - 1][1]);
        const el = document.getElementById("kp");
        if (el) {
            el.textContent = val.toFixed(1);
            el.className = `badge ${val >= 5 ? 'high' : (val >= 3 ? 'mid' : 'low')}`;
        }
        return val;
    } catch (e) {
        console.error("Kp Fetch Error:", e);
        return 0;
    }
}

async function checkOval() {
    try {
        const targetUrl = OVAL_URL + "?t=" + Date.now();
        const res = await fetch(CORS + encodeURIComponent(targetUrl));
        
        // GASãƒ—ãƒ­ã‚­ã‚·çµŒç”±ãªã®ã§ã€ç›´æ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å—ã‘å–ã‚‹
        const data = await res.json(); 

        // data.contents ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¨ JSON.parse ã¯ä¸è¦ã«ãªã£ãŸã®ã§å‰Šé™¤
        if (!data || !data.coordinates) return;

        cachedAuroraData = data;
        if (typeof map !== 'undefined' && map) drawAurora(data);

        let best = 0;
        data.coordinates.forEach(p => {
            let lon = p[0] > 180 ? p[0] - 360 : p[0];
            let lat = p[1];
            // è‡ªåˆ†ã®ä½ç½®ã«è¿‘ã„åº§æ¨™ã‚’æ¢ã™
            if (Math.abs(myLat - lat) < 2 && Math.abs(myLon - lon) < 2) {
                best = Math.max(best, p[2]);
            }
        });

        lastAuroraProb = best;
        const el = document.getElementById("oval");
        if (el) {
            el.textContent = best >= 10 ? "Near Oval" : "Outside";
            el.className = `badge ${best >= 10 ? 'high' : 'low'}`;
        }
    } catch (e) {
        console.error("Oval fetch error:", e);
    }
}

async function fetchKp3DayForecast() {
    try {
        const res = await fetch(CORS + encodeURIComponent(FORECAST_URL));
        
        // GASãƒ—ãƒ­ã‚­ã‚·ãŒNOAAã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾è¿”ã—ã¦ãã‚‹
        // JSONå½¢å¼ã§ã¯ãªããƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å—ã‘å–ã‚‹ãŸã‚ã€ã“ã“ã ã‘ .text() ã«ã—ã¾ã™
        const text = await res.text(); 
        
        const match = text.match(/NOAA Kp index breakdown[\s\S]*?(?=\n[A-Z]|$)/i);
        const el = document.getElementById("kpForecast");
        if (el) {
            el.innerText = match ? match[0].trim() : "Updating...";
        }
    } catch (e) {
        console.error("Forecast Error:", e);
    }
}

async function getCloud(isDaytime = false) {
    if (myLat === null || myLon === null) return;

    try {
        // 1. ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã‚‹ (CORSãƒ—ãƒ­ã‚­ã‚·ä¸è¦)
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${myLat}&longitude=${myLon}&current=cloudcover&hourly=cloudcover&timezone=auto`);
        const data = await res.json();
        
        if (!data || !data.hourly || !data.current) return; 

        // 2. ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã€Œå¾Œã€ã§å¤‰æ•°ã‚’å–ã‚Šå‡ºã™
        cloudDataHourly = data.hourly.cloudcover;
        const currentCloud = data.current.cloudcover;
        const hourIndex = 21; // ç¾åœ°æ™‚é–“ã®21æ™‚ (timezone=autoã®ãŠã‹ã’)
        const tonightCloud = cloudDataHourly[hourIndex] || currentCloud;

        // æ˜¼é–“ãªã‚‰ä»Šå¤œã®äºˆå ±(21æ™‚)ã€å¤œé–“ãªã‚‰ä»Šã®é›²é‡ã‚’æ¡ç”¨
        let val = isDaytime ? tonightCloud : currentCloud;

        const el = document.getElementById("cloud");
        if (el) {
            // è¡¨è¨˜ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
            let displayValue;
            if (val <= 5) {
                displayValue = "Clear";
            } else if (val >= 95) {
                displayValue = "Overcast";
            } else {
                displayValue = val + "%";
            }

            el.textContent = displayValue; 
            el.dataset.value = val;
            // é›²ãŒå°‘ãªã„(20ä»¥ä¸‹)ã»ã©ã‚ªãƒ¼ãƒ­ãƒ©ãŒè¦‹ã‚„ã™ã„ã®ã§ 'high' (ç·‘)
            el.className = `badge ${val <= 20 ? 'high' : (val <= 60 ? 'mid' : 'low')}`;
        }
    } catch (e) {
        console.error("Cloud Fetch Error:", e);
    }
}

async function shortForecast() {
    if (!cloudDataHourly) return;
    
    // 1. ç¾åœ°æ™‚é–“ã®è¨ˆç®— (çµŒåº¦ myLon ã‚’ä½¿ç”¨)
    const now = new Date();
    const utcHr = now.getUTCHours();
    const localHr = (utcHr + Math.round(myLon / 15) + 24) % 24; 

    // 2. å¤‰æ•°ã®æº–å‚™
    let label1 = "";
    let val1 = 0;
    
    // 3. æ™‚é–“å¸¯ã«ã‚ˆã‚‹åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯
    if (localHr >= 3 && localHr < 21) {
        // --- æ˜¼é–“ (3:00 - 21:00) ---
        // ãƒ©ãƒ™ãƒ«: Tonight (21:00) / ä»Šå¤œ (21:00)
        label1 = "Tonight (21:00)";
        val1 = cloudDataHourly[21] || 0; 
    } else {
        // --- å¤œé–“ (21:00 - ç¿Œ3:00) ---
        // ãƒ©ãƒ™ãƒ«: In 3 Hours / 3æ™‚é–“å¾Œ
        label1 = "In 3 hours";
        // ç¾åœ¨ã®UTCæ™‚é–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰3ã¤å…ˆã‚’å–å¾—
        val1 = cloudDataHourly[utcHr + 3] || 0; 
    }

    // æ˜æ—¥ã®äºˆå ± (24æ™‚é–“å¾Œ) ã¯å…±é€š
    const val2 = cloudDataHourly[utcHr + 24] || 0;

    // 0%ã¨100%ã‚’é¿ã‘ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
    const formatCloud = (val) => {
        if (val <= 0) return "< 1%";
        if (val >= 100) return "> 99%";
        return val + "%";
    };

    const el = document.getElementById("forecast");
    if (el) {
        el.innerHTML = `
            <div>ğŸ•’ ${label1} : ${formatCloud(val1)}</div>
            <div>ğŸ“… Tomorrow : ${formatCloud(val2)}</div>
        `;
    }
}

// --- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆä¿æŒç”¨ã®å¤‰æ•° ---
let myRadarChart = null;

function calculateTotal() {
    // 1. å„è¦ç´ ã®å–å¾—ã¨æ•°å€¤åŒ–
    const kp = parseFloat(document.getElementById("kp").textContent) || 0;
    const cloud = parseInt(document.getElementById("cloud").dataset.value) || 0;
    const icon = document.getElementById("status-icon");

    // 2. åŸºæœ¬ã‚¹ã‚³ã‚¢è¨ˆç®—
    let score = (lastAuroraProb * 1.2) + (kp * 10);
    
    // ä½ç·¯åº¦ãƒ»é è·é›¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (lastAuroraProb < 5) score *= 0.01;

    // é›²é‡ã«ã‚ˆã‚‹æœ€çµ‚æ¸›è¡° (è¡¨ç¤ºä¸Šã®ã‚¹ã‚³ã‚¢ã«åæ˜ )
    let finalScore = score;
    if (cloud > 85) finalScore *= 0.1;

    // 3. è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã¨ãƒãƒƒã‚¸è‰²ã®æ±ºå®š
    const resultStatus = finalScore >= 70 ? "High" : (finalScore >= 35 ? "Possible" : "Low");
    const resEl = document.getElementById("result");
    if (resEl) {
        resEl.textContent = resultStatus;
        resEl.className = `badge badge-large ${resultStatus.toLowerCase()}`;
    }

    // 4. ç”»åƒã‚¢ã‚¤ã‚³ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
    if (icon) {
        if (resultStatus === "High") {
            icon.src = "high.png";
        } else if (resultStatus === "Possible") {
            icon.src = "possible.png";
        } else {
            // Lowã‹ã¤ã€Œã‚‚ã—æ™´ã‚Œã¦ã„ã‚Œã°ãƒãƒ£ãƒ³ã‚¹ãŒã‚ã£ãŸã€å ´åˆã¯é›²ã‚¢ã‚¤ã‚³ãƒ³
            if (score >= 35 && cloud >= 70) {
                icon.src = "cloud.png";
            } else {
                icon.src = "low.png";
            }
        }
    }

    // æ•°å€¤ã‚’ä¿æŒ
    currentTotalScore = finalScore;
    const pctEl = document.getElementById("score-pct");
    if (pctEl) pctEl.textContent = (finalScore < 1 ? "< 1%" : (finalScore > 99 ? "> 99%" : Math.round(finalScore) + "%"));
}

/**
 * ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
 */
function updateRadarChart() {
    const ctx = document.getElementById('radarChart').getContext('2d');
    const kp = parseFloat(document.getElementById("kp").textContent) || 0;
    const cloud = parseInt(document.getElementById("cloud").dataset.value) || 0;

    // 3è»¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’ 0-100 ã«æ­£è¦åŒ–
    const dataValues = [
        Math.min(lastAuroraProb * 2, 100), // Oval/Horizon (50%ä»¥ä¸Šã§æº€ç‚¹)
        Math.min(kp * 12.5, 100),         // Magnetic (Kp 8ä»¥ä¸Šã§æº€ç‚¹)
        Math.max(100 - cloud, 0)          // Sky (å¿«æ™´ã§æº€ç‚¹)
    ];

    // ä¸­å¤®ã®ï¼…è¡¨ç¤ºã‚’æ›´æ–°
    const pctText = currentTotalScore < 1 ? "<1%" : (currentTotalScore > 99 ? "99%+" : Math.round(currentTotalScore) + "%");
    document.getElementById('chart-center-pct').textContent = pctText;

    if (myRadarChart) {
        myRadarChart.data.datasets[0].data = dataValues;
        myRadarChart.update();
    } else {
        myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Oval / Horizon', 'Magnetic (Kp)', 'Sky (Clear)'],
                datasets: [{
                    data: dataValues,
                    backgroundColor: 'rgba(91, 192, 190, 0.3)', // #5bc0be
                    borderColor: 'rgba(91, 192, 190, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
               responsive: true,
               maintainAspectRatio: false,
               // â˜… 1. ä½™ç™½ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ã‚’ã‚¼ãƒ­ã«è¨­å®š
               layout: {
                  padding: {
                     top: 0,
                     bottom: 0,
                     left: 0,
                     right: 0,
                  }
               },

                plugins: { legend: { display: false } 
                },
                scales: {
                    r: {
                        startAngle: 0, // ã‚°ãƒ©ãƒ•ã®é–‹å§‹è§’åº¦ã‚’0åº¦ã«å›ºå®š
                        min: 0,
                        max: 100,
                        beginAtZero: true,
                        ticks: { display: false, stepSize: 25 },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                        pointLabels: { color: '#8b949e', font: { size: 10 } }
                    }
                },
                animation: { duration: 800 }
            }
        });
    }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°ã‚’æ‹¡å¼µ
function openModal() { 
    document.getElementById("detailModal").style.display = "flex"; 
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã‹ã‚‰ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»ï¼ˆã‚µã‚¤ã‚ºè¨ˆç®—ã®ãŸã‚ï¼‰
    setTimeout(updateRadarChart, 100);
}

// --- 6. åœ°å›³ãƒ»UIãƒ»ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
function initMap() {
    if (map) return; // äºŒé‡åˆæœŸåŒ–é˜²æ­¢

    const southLimit = -70, northLimit = 90;
    map = L.map('map', { 
        minZoom: 2, 
        maxZoom: 10, 
        worldCopyJump: true, 
        maxBounds: [[southLimit, -540], [northLimit, 540]], 
        maxBoundsViscosity: 1.0 
    });

    // ãƒãƒ¼ã‚«ãƒ¼ã‚’æœ€å‰é¢ã«æŒã£ã¦ãã‚‹è¨­å®šã‚’å¾©å…ƒ
    map.createPane('userMarkerPane');
    map.getPane('userMarkerPane').style.zIndex = 650;ã€€// ã‚ªãƒ¼ãƒ­ãƒ©(400)ã‚ˆã‚Šä¸Šã«
    // map.getPane('userMarkerPane').style.pointerEvents = 'none';

    const startLat = myLat !== null ? myLat : 70;
    const startLon = myLon !== null ? myLon : 0;
    map.setView([startLat, startLon], 3);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
        noWrap: false 
    }).addTo(map);
    
    auroraLayer = L.layerGroup().addTo(map); 
    if (cachedAuroraData) drawAurora(cachedAuroraData); 
    updateMapMarker(); 
}

function drawAurora(data) {
    if (!auroraLayer) return;
    auroraLayer.clearLayers();
    
    if (!data || !data.coordinates) return;

    data.coordinates.forEach(p => {
        if (p[2] > 10) { 
            let baseLon = p[0] > 180 ? p[0] - 360 : p[0];
            let color = p[2] > 50 ? '#ff4500' : (p[2] > 25 ? '#ffff00' : '#00ff00');
            
            // åœ°å›³ã‚’ãƒ«ãƒ¼ãƒ—ã•ã›ã¦ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã« -360, 0, 360 ã®3ç®‡æ‰€ã«æã
            [-360, 0, 360].forEach(offset => {
                L.rectangle(
                    [[p[1], baseLon + offset], [p[1] + 2, baseLon + 2 + offset]], 
                    { 
                        color: color, 
                        weight: 0, 
                        fillOpacity: p[2] / 100, 
                        interactive: false 
                    }
                ).addTo(auroraLayer);
            });
        }
    });
}

// å¼•æ•°ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼ˆå¼•æ•°ãŒãªã„å ´åˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨ï¼‰
function updateMapMarker(targetLat = myLat, targetLon = myLon) {
    if (!map || myLat === null) return;
    
    const pos = [targetLat, targetLon];
    
    // ã™ã§ã«å­˜åœ¨ã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã«ã€Œæ–°ã—ã„ä½ç½®ã€ã‚’å³åº§ã«åæ˜ 
    if (userMarker) {
        userMarker.setLatLng(pos);
        userMarker.bringToFront(); // é‡ãªã‚Šé †ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã«å¿µã®ãŸã‚
        return;
    }

    // åˆå›ä½œæˆæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
    userMarker = L.circleMarker(pos, { 
        fillColor: '#00ffff', // é®®ã‚„ã‹ãªã‚·ã‚¢ãƒ³
        radius: 8, 
        stroke: false,        // æ ç·šã‚’ã‚ªãƒ•
        fillOpacity: 1,       // å®Œå…¨ã«ä¸é€æ˜ã«ã—ã¦ç›®ç«‹ãŸã›ã‚‹
        pane: 'userMarkerPane'    // æ¨™æº–ã®ãƒãƒ¼ã‚«ãƒ¼ç”¨ãƒšã‚¤ãƒ³ï¼ˆæœ€å‰é¢ä»˜è¿‘ï¼‰ã‚’æŒ‡å®šã€ã“ã“ã‚’ initMap ã®è¨­å®šã¨åˆã‚ã›ã‚‹ï¼
    }).addTo(map);
}

function showMapScreen() {
    document.getElementById('home-screen').style.display = 'none';
    document.getElementById('map-screen').style.display = 'block';
    setTimeout(() => { initMap(); map.invalidateSize(); }, 100);
}

function hideMapScreen() {
    document.getElementById('map-screen').style.display = 'none';
    document.getElementById('home-screen').style.display = 'block';
}

function setItemLoading(id, isLoading) {
    const el = document.getElementById(id);
    if (el && isLoading) {
        // ç ‚æ™‚è¨ˆã‚¢ã‚¤ã‚³ãƒ³ â³ ã¨ æ–œä½“ã® Loading... ã‚’ã‚»ãƒƒãƒˆ
        el.innerHTML = 'â³ <i>Loading...</i>';
    }
}

function closeWelcome() { document.getElementById('welcome-overlay').style.display = 'none'; }

function openModal() { 
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById("detailModal").style.display = "flex"; 
    
    // ã‚¹ã‚³ã‚¢ã®è¡¨ç¤ºï¼ˆã‚‚ã—HTMLã« score-pct ãŒæ®‹ã£ã¦ã„ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    const pctText = currentTotalScore < 1 ? "< 1%" : (currentTotalScore > 99 ? "> 99%" : Math.round(currentTotalScore) + "%");
    const pctEl = document.getElementById("score-pct");
    if (pctEl) pctEl.textContent = pctText;

    // ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»ï¼ˆã“ã®ä¸­ã®å‡¦ç†ã§ chart-center-pct ã‚’æ›´æ–°ã—ã¾ã™ï¼‰
    setTimeout(updateRadarChart, 100);
}

function closeModal() { document.getElementById("detailModal").style.display = "none"; }

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
}

async function reverseGeocode(lat, lon) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`);
        const data = await res.json();
        if (!data) return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°å‡¦ç†ã‚’ä¸­æ–­
        // â˜… å¤‰æ•° 'name' ã‚’ã“ã“ã§å®šç¾©
        const name = (data.address.city || data.address.town || "Unknown") + ", " + data.address.country;
        document.getElementById("loc").textContent = name;
        return name; // â˜… å–å¾—ã—ãŸåå‰ã‚’è¿”ã‚Šå€¤ã¨ã—ã¦è¿½åŠ 
    } catch (e) { 
        const fallback = lat.toFixed(2) + ", " + lon.toFixed(2);
        document.getElementById("loc").textContent = fallback;
        return fallback; // â˜… ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚åº§æ¨™ã‚’åå‰ã¨ã—ã¦è¿”ã™
    }
}

function updateTimestamp(id) {
    const el = document.getElementById(id);
    if (el) el.textContent = `Last Update: ${new Date().toLocaleTimeString()}`;
}

function toggleData() {
    const h = document.getElementById("hidden-data");
    const isH = h.style.display !== "block";
    h.style.display = isH ? "block" : "none";
}


/**
 * æ¬¡å›ã®æ›´æ–°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç®¡ç†ã™ã‚‹é–¢æ•°
 */
/**
 * æ¬¡å›ã®æ›´æ–°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç®¡ç†ã™ã‚‹é–¢æ•°
 * ã“ã‚ŒãŒ setInterval ã®ä»£ã‚ã‚Šã«ãªã‚Šã¾ã™
 */
function scheduleNextUpdate() {
    const now = new Date();
    const hour = now.getHours();

    // æ˜¼é–“ (3:00 - 21:00) ã¯ 60åˆ†ã€å¤œé–“ã¯ 15åˆ†
    const intervalMinutes = (hour >= 3 && hour < 21) ? 60 : 15;
    const intervalMs = intervalMinutes * 60 * 1000;

    console.log(`[Timer] æ¬¡å›ã®è‡ªå‹•æ›´æ–°ã¯ ${intervalMinutes} åˆ†å¾Œã§ã™ã€‚`);

    // é‡è¤‡å‹•ä½œã‚’é˜²ããŸã‚ã«æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (window.autoUpdateTimeout) {
        clearTimeout(window.autoUpdateTimeout);
    }

    // æŒ‡å®šæ™‚é–“å¾Œã«å®Ÿè¡Œ
    window.autoUpdateTimeout = setTimeout(async () => {
        console.log("Auto-update execution started.");
        
        try {
            await updateAll(); // ã“ã“ã§æ—¢å­˜ã® updateAll ã‚’å‘¼ã³å‡ºã™
        } catch (e) {
            console.error("Auto-update error:", e);
        }

        // å®Ÿè¡ŒãŒçµ‚ã‚ã£ãŸã‚‰ã€ã¾ãŸæ¬¡ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç«‹ã¦ã‚‹ï¼ˆå†å¸°å‘¼ã³å‡ºã—ï¼‰
        scheduleNextUpdate();
    }, intervalMs);
}

// æœ€åˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹å§‹(åˆå›å®Ÿè¡Œã®ãƒˆãƒªã‚¬ãƒ¼ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ãªã©ï¼‰)
scheduleNextUpdate();


</script>
</body>
</html>




